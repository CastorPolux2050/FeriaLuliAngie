<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feria Luli Angie</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: Arial, sans-serif; background: linear-gradient(135deg,#667eea,#764ba2); min-height:100vh; padding:20px; }
    .container { max-width:800px; margin:0 auto; background:#fff; border-radius:15px; padding:30px; box-shadow:0 10px 30px rgba(0,0,0,.2); }
    h1 { text-align:center; color:#333; margin-bottom:30px; font-size:2.5em; text-shadow:2px 2px 4px rgba(0,0,0,.1); }
    .search-section { margin-bottom:30px; }
    .search-input { width:100%; padding:15px; font-size:16px; border:2px solid #ddd; border-radius:8px; margin-bottom:10px; transition:border-color .3s; }
    .search-input:focus { outline:none; border-color:#667eea; }
    .suggestions { max-height:200px; overflow-y:auto; border:1px solid #ddd; border-radius:8px; background:#fff; display:none; }
    .suggestion-item { padding:12px; cursor:pointer; border-bottom:1px solid #eee; transition:background-color .2s; }
    .suggestion-item:hover { background:#f5f5f5; }
    .suggestion-item.sold { background:#ffebee; color:#c62828; }

    .cart-section { margin-bottom:30px; }
    .cart-item { display:flex; justify-content:space-between; align-items:center; padding:15px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px; background:#f9f9f9; }
    .cart-item.sold { background:#ffebee; color:#c62828; border-color:#c62828; }
    .cart-item-info { flex:1; }
    .cart-item-price { font-weight:bold; font-size:18px; text-align:left; }
    .remove-btn { background:#ff4444; color:#fff; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; margin-left:10px; }
    .remove-btn:hover { background:#cc0000; }

    .disc-row { margin-top:8px; font-size:14px; display:flex; align-items:center; gap:8px; }
    .discount-input { width:70px; padding:6px; border:1px solid #ddd; border-radius:6px; text-align:left; }
    /* Ocultar flechas del number */
    input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; appearance: textfield; }

    .final-price { font-weight:bold; }
    .strikethrough { text-decoration: line-through; color:#888; margin-right:6px; }

    .total-section { background:#f0f8ff; padding:20px; border-radius:8px; margin-bottom:30px; text-align:center; }
    .total-amount { font-size:2em; font-weight:bold; color:#333; margin-bottom:20px; }

    .payment-buttons { display:grid; grid-template-columns:1fr 1fr; gap:15px; max-width:500px; margin:0 auto; }
    .payment-btn { padding:20px 15px; font-size:16px; border:none; border-radius:8px; cursor:pointer; transition:all .3s; font-weight:bold; text-align:center; }
    .payment-btn:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,.2); }
    .btn-efvo-luli { background:#1976D2; color:#fff; }
    .btn-alias-luli { background:#42A5F5; color:#fff; }
    .btn-efvo-angie { background:#F57C00; color:#fff; }
    .btn-alias-angie { background:#FFB74D; color:#fff; }

    .modal { display:none; position:fixed; z-index:1000; inset:0; background:rgba(0,0,0,.5); }
    .modal-content { background:#fff; margin:10% auto; padding:30px; border-radius:15px; width:90%; max-width:500px; text-align:center; }
    .annotation-section { margin:20px 0; text-align:left; }
    .annotation-label { display:block; margin-bottom:8px; font-weight:bold; color:#333; }
    .annotation-input { width:100%; padding:10px; border:2px solid #ddd; border-radius:8px; font-size:14px; resize:vertical; min-height:60px; font-family:Arial,sans-serif; }
    .annotation-input:focus { outline:none; border-color:#667eea; }
    .modal-buttons { display:flex; gap:20px; justify-content:center; margin-top:20px; }
    .modal-btn { padding:12px 30px; font-size:16px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
    .btn-cancel { background:#666; color:#fff; }
    .btn-confirm { background:#4CAF50; color:#fff; }

    .empty-cart { text-align:center; color:#666; font-style:italic; padding:20px; }

    @media (max-width:600px){
      .container{ padding:20px; }
      .payment-buttons{ grid-template-columns:1fr; gap:10px; }
      .modal-buttons{ flex-direction:column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üõçÔ∏è Feria Luli Angie</h1>

    <div class="search-section">
      <input type="text" id="searchInput" class="search-input" placeholder="Buscar producto por c√≥digo, nombre o descripci√≥n...">
      <div id="suggestions" class="suggestions"></div>
    </div>

    <div class="cart-section">
      <h2>Productos Seleccionados</h2>
      <div id="cartItems">
        <div class="empty-cart">No hay productos seleccionados</div>
      </div>
    </div>

    <div class="total-section">
      <div class="total-amount">Total: $<span id="totalAmount">0</span></div>
      <div class="payment-buttons">
        <button class="payment-btn btn-efvo-luli" onclick="showPaymentModal('Efvo Luli')">üíµ Efvo Luli</button>
        <button class="payment-btn btn-efvo-angie" onclick="showPaymentModal('Efvo Angie')">üíµ Efvo Angie</button>
        <button class="payment-btn btn-alias-luli" onclick="showPaymentModal('Alias Luli')">üè¶ Alias Luli</button>
        <button class="payment-btn btn-alias-angie" onclick="showPaymentModal('Alias Angie')">üè¶ Alias Angie</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="paymentModal" class="modal">
    <div class="modal-content">
      <h2>Confirmar Venta</h2>
      <p id="paymentMessage"></p>
      <div class="annotation-section">
        <label class="annotation-label">Anotaci√≥n:</label>
        <textarea id="annotationInput" class="annotation-input" placeholder="Agregar comentario o anotaci√≥n (opcional)..."></textarea>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn btn-cancel" onclick="closeModal()">Cancelar</button>
        <button class="modal-btn btn-confirm" onclick="confirmSale()">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Supabase =====
    const supabaseUrl = 'https://lgfvmqmbhhpbtxczpdln.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnZnZtcW1iaGhwYnR4Y3pwZGxuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NTk5MjMsImV4cCI6MjA2NzIzNTkyM30.Akur-f50hXwTkP3pshnMywEUUj0Ev8jCFNo88NiyyVI';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // ===== Estado =====
    let productos = [];
    let carrito = [];
    let descuentos = {}; // { idProducto: entero 0‚Äì100 }
    let currentPaymentMethod = '';

    // ===== Util =====
    const money = n => Number(n||0).toLocaleString('es-AR');

    const clamp = (n,min,max) => Math.min(max, Math.max(min, n));
    const precioFinal = (item) => {
      const d = clamp(parseInt(descuentos[item.id]||0,10)||0, 0, 100);
      return Math.max(0, Number(item.precio||0) * (1 - d/100));
    };

    function sanitizeInt(value){
      const m = String(value).match(/\d+/);
      return m ? m[0] : '0';
    }
    function shouldAutoBlur(intStr){
      if (!intStr) return false;
      if (intStr === '10') return false;                 // permitir tipear 100
      if (intStr.length >= 3) return parseInt(intStr,10) === 100; // 100 ‚Üí 3 d√≠gitos
      return intStr.length >= 2;                          // 20, 35, etc.
    }

    // ===== Cargar productos =====
    async function loadProductos() {
      try {
        const { data, error } = await supabase.from('productos').select('*').order('codigo');
        if (error) throw error;
        productos = data || [];
      } catch (e) {
        console.error('Error cargando productos:', e);
        alert('Error al cargar productos');
      }
    }

    // ===== B√∫squeda =====
    function searchProductos(query) {
      if (!query.trim()) return [];
      const q = query.toLowerCase();
      return productos.filter(p =>
        String(p.codigo||'').toLowerCase().includes(q) ||
        String(p.nombre||'').toLowerCase().includes(q) ||
        String(p.descripcion||'').toLowerCase().includes(q) ||
        String(p.tipo||'').toLowerCase().includes(q)
      );
    }

    function showSuggestions(results) {
      const suggestionsDiv = document.getElementById('suggestions');
      if (!results.length) { suggestionsDiv.style.display = 'none'; return; }
      suggestionsDiv.innerHTML = results.map(producto => `
        <div class="suggestion-item ${producto.vendido ? 'sold' : ''}" onclick="addToCart(${producto.id})">
          <strong>${producto.codigo}</strong> - ${producto.nombre} - ${producto.descripcion||''}
          <br><small>${producto.tipo||''} | $${money(producto.precio)}</small>
          ${producto.vendido ? '<br><small>‚ö†Ô∏è YA VENDIDO</small>' : ''}
        </div>
      `).join('');
      suggestionsDiv.style.display = 'block';
    }

    // ===== Carrito =====
    function addToCart(productoId) {
      const producto = productos.find(p => p.id === productoId);
      if (!producto) return;
      if (carrito.find(x => x.id === productoId)) { alert('Este producto ya est√° en el carrito'); return; }
      carrito.push(producto);
      descuentos[productoId] = 0; // default
      renderCart();
      updateTotal();
      document.getElementById('searchInput').value = '';
      document.getElementById('suggestions').style.display = 'none';
    }

    function removeFromCart(productoId) {
      carrito = carrito.filter(x => x.id !== productoId);
      delete descuentos[productoId];
      renderCart();
      updateTotal();
    }

    function onChangeDiscount(id, rawValue){
      const intStr = sanitizeInt(rawValue);
      let v = parseInt(intStr,10); if (isNaN(v)) v = 0;
      v = clamp(v, 0, 100);
      descuentos[id] = v;

      // reflejar valor limpio
      const input = document.getElementById('disc-' + id);
      if (input) input.value = v;

      // actualizar precio final del item
      const item = carrito.find(i => i.id === id);
      if (item) {
        const final = document.getElementById('final-' + id);
        if (final) final.textContent = '$' + money(precioFinal(item));
      }
      updateTotal();

      // auto-blur al 2¬∞ d√≠gito (o 3 para 100)
      if (input && shouldAutoBlur(intStr)) {
        input.blur();
      }
    }

    function renderCart(){
      const cartItemsDiv = document.getElementById('cartItems');
      if (!carrito.length) { cartItemsDiv.innerHTML = '<div class="empty-cart">No hay productos seleccionados</div>'; return; }

      cartItemsDiv.innerHTML = carrito.map(item => {
        const d = descuentos[item.id] || 0;
        const p = Number(item.precio||0);
        const pf = precioFinal(item);
        const hasDisc = d > 0;
        return `
          <div class="cart-item ${item.vendido ? 'sold' : ''}">
            <div class="cart-item-info">
              <div><strong>${item.codigo}</strong> - ${item.nombre}</div>
              <div><small>${item.descripcion||''}</small></div>
              ${item.vendido ? '<div><small>‚ö†Ô∏è YA VENDIDO</small></div>' : ''}
              <div class="disc-row">
                <span>Desc %</span>
                <input id="disc-${item.id}" class="discount-input" type="number" inputmode="numeric" pattern="[0-9]*" min="0" max="100" step="1" value="${d}"
                  oninput="onChangeDiscount(${item.id}, this.value)" /> 
                <span>Final:</span>
                <span id="final-${item.id}" class="final-price">$${money(pf)}</span>
              </div>
            </div>
            <div class="cart-item-price">
              ${hasDisc ? `<span class="strikethrough">$${money(p)}</span>` : ''}$${money(hasDisc ? pf : p)}
            </div>
            <button class="remove-btn" onclick="removeFromCart(${item.id})">‚ùå</button>
          </div>
        `;
      }).join('');
    }

    function updateTotal(){
      const total = carrito.reduce((sum, item) => sum + precioFinal(item), 0);
      document.getElementById('totalAmount').textContent = money(total);
    }

    // ===== Pago / Modal =====
    function showPaymentModal(method){
      if (!carrito.length) { alert('No hay productos seleccionados'); return; }
      currentPaymentMethod = method;
      const total = carrito.reduce((s,i)=> s + precioFinal(i), 0);
      document.getElementById('paymentMessage').innerHTML = `
        <strong>Venta mediante ${method}</strong><br>
        por $${money(total)}<br><br>
        ¬øConfirmar venta?
      `;
      document.getElementById('annotationInput').value = '';
      document.getElementById('paymentModal').style.display = 'block';
    }
    function closeModal(){ document.getElementById('paymentModal').style.display = 'none'; }

    async function confirmSale(){
      try {
        const fechaHora = new Date().toISOString();
        const anotacionBase = document.getElementById('annotationInput').value.trim();

        for (const item of carrito) {
          const d = descuentos[item.id] || 0;
          const pf = precioFinal(item);
          const anotacion = [anotacionBase, `Desc ${d}% ‚Üí $${money(pf)}`, item.vendido ? 'VENDIDO NUEVAMENTE' : null]
                            .filter(Boolean).join(' | ');

          const { error } = await supabase
            .from('productos')
            .update({ vendido: 1, fecha_hora_venta: fechaHora, medio_de_pago: currentPaymentMethod, anotacion })
            .eq('id', item.id);
          if (error) throw error;
        }

        alert('¬°Venta confirmada exitosamente!');
        window.location.reload();
      } catch (e) {
        console.error('Error confirmando venta:', e);
        alert('Error al confirmar la venta');
      }
    }

    // ===== Listeners =====
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const q = e.target.value;
      if ((q||'').length >= 2) showSuggestions(searchProductos(q));
      else document.getElementById('suggestions').style.display = 'none';
    });
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-section')) document.getElementById('suggestions').style.display = 'none';
    });
    window.onclick = function(ev){ const m = document.getElementById('paymentModal'); if (ev.target === m) closeModal(); };

    // Solo n√∫meros en inputs de descuento
    document.addEventListener('keydown', (e) => {
      const t = e.target;
      if (t && t.classList && t.classList.contains('discount-input')) {
        const allowed = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab'];
        if (allowed.includes(e.key)) return;
        if (!/^[0-9]$/.test(e.key)) e.preventDefault();
      }
    });

    // Init
    loadProductos();
  </script>
</body>
</html>
